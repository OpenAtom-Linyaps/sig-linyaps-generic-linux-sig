From 4a9574639adb96e105dca388350b1b44d33e18e2 Mon Sep 17 00:00:00 2001
From: LFRon <ronforever@outlook.com>
Date: Mon, 29 Sep 2025 20:25:37 +0800
Subject: [PATCH] Patch for Generic Linux Distribution

---
 debian/control                                |  4 +-
 debian/linglong-bin.install                   |  1 -
 debian/linglong-bin.postinst                  |  1 -
 debian/patches/0001-add-mount-dirs.patch      | 16 -------
 ...02-deepin-specifies-export-directory.patch | 15 -------
 .../patches/0003-add-linyaps-preloader.patch  | 39 ----------------
 .../0004-deepin-skip-path-mapping.patch       | 25 -----------
 debian/patches/0005-repo-token.patch          | 45 -------------------
 debian/patches/series                         |  5 ---
 debian/rules                                  |  2 +-
 libs/dbus-api/CMakeLists.txt                  |  2 +-
 11 files changed, 4 insertions(+), 151 deletions(-)
 delete mode 100644 debian/patches/0001-add-mount-dirs.patch
 delete mode 100644 debian/patches/0002-deepin-specifies-export-directory.patch
 delete mode 100644 debian/patches/0003-add-linyaps-preloader.patch
 delete mode 100644 debian/patches/0004-deepin-skip-path-mapping.patch
 delete mode 100644 debian/patches/0005-repo-token.patch
 delete mode 100644 debian/patches/series

diff --git a/debian/control b/debian/control
index 974637b2..301f09b6 100644
--- a/debian/control
+++ b/debian/control
@@ -25,8 +25,8 @@ Build-Depends: cmake,
                libzstd-dev,
                nlohmann-json3-dev (>= 3.5.0),
                pkg-config,
-               qt6-base-dev | qtbase5-dev,
-               qt6-base-private-dev | qtbase5-private-dev,
+               qtbase5-dev | qt6-base-dev,
+               qtbase5-private-dev | qt6-base-private-dev,
                systemd,
                zlib1g-dev,
                libcap-dev
diff --git a/debian/linglong-bin.install b/debian/linglong-bin.install
index 3cc95c1b..f0929bcf 100644
--- a/debian/linglong-bin.install
+++ b/debian/linglong-bin.install
@@ -8,7 +8,6 @@ usr/lib/systemd/system-environment-generators/61-linglong
 usr/lib/systemd/user-generators/linglong-user-systemd-generator
 usr/lib/systemd/system/org.deepin.linglong.PackageManager.service lib/systemd/system/
 usr/lib/systemd/user/linglong-session-helper.service
-usr/lib/systemd/user/cn.org.linyaps.preloader.service
 usr/lib/sysusers.d/linglong.conf
 usr/lib/tmpfiles.d/linglong.conf
 usr/libexec/linglong/ll-package-manager
diff --git a/debian/linglong-bin.postinst b/debian/linglong-bin.postinst
index 17a9163a..8b9fdb49 100644
--- a/debian/linglong-bin.postinst
+++ b/debian/linglong-bin.postinst
@@ -28,7 +28,6 @@ if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-decon
                 done
                 for instance in $instances; do
                         systemctl --user --machine="$instance"@ restart linglong-session-helper.service >/dev/null || true
-                        systemctl --global --machine="${instance}"@ enable cn.org.linyaps.preloader.service > /dev/null || true
                 done
         fi
 fi
diff --git a/debian/patches/0001-add-mount-dirs.patch b/debian/patches/0001-add-mount-dirs.patch
deleted file mode 100644
index 594cf532..00000000
--- a/debian/patches/0001-add-mount-dirs.patch
+++ /dev/null
@@ -1,16 +0,0 @@
-Index: linyaps/libs/oci-cfg-generators/src/linglong/oci-cfg-generators/container_cfg_builder.cpp
-===================================================================
---- linyaps.orig/libs/oci-cfg-generators/src/linglong/oci-cfg-generators/container_cfg_builder.cpp
-+++ linyaps/libs/oci-cfg-generators/src/linglong/oci-cfg-generators/container_cfg_builder.cpp
-@@ -390,6 +390,11 @@ ContainerCfgBuilder &ContainerCfgBuilder
-         "/usr/share/icons",
-         "/usr/share/themes",
-         "/var/cache/fontconfig",
-+        "/usr/share/wallpapers",
-+        "/usr/share/music",
-+        "/usr/share/extensions-from-app-store",
-+        "/usr/share/dsg",
-+        "/usr/share/deepin/distribution.info"
-     };
- 
-     hostStaticsMount = std::vector<Mount>{};
diff --git a/debian/patches/0002-deepin-specifies-export-directory.patch b/debian/patches/0002-deepin-specifies-export-directory.patch
deleted file mode 100644
index 393adc3f..00000000
--- a/debian/patches/0002-deepin-specifies-export-directory.patch
+++ /dev/null
@@ -1,15 +0,0 @@
-Index: linyaps/misc/share/linglong/export-dirs.json
-===================================================================
---- linyaps.orig/misc/share/linglong/export-dirs.json
-+++ linyaps/misc/share/linglong/export-dirs.json
-@@ -8,6 +8,9 @@
-         "share/appdata",
-         "share/metainfo",
-         "share/plugins",
--        "share/templates"
-+        "share/templates",
-+        "share/deepin-manual",
-+        "share/deepin-elf-verify",
-+        "share/dsg"
-     ]
- }
diff --git a/debian/patches/0003-add-linyaps-preloader.patch b/debian/patches/0003-add-linyaps-preloader.patch
deleted file mode 100644
index 13733fb3..00000000
--- a/debian/patches/0003-add-linyaps-preloader.patch
+++ /dev/null
@@ -1,39 +0,0 @@
-Index: linyaps/misc/CMakeLists.txt
-===================================================================
---- linyaps.orig/misc/CMakeLists.txt
-+++ linyaps/misc/CMakeLists.txt
-@@ -43,6 +43,7 @@ configure_files(
-   lib/systemd/system-preset/91-linglong.preset
-   lib/systemd/user-generators/linglong-user-systemd-generator
-   lib/systemd/user/linglong-session-helper.service
-+  lib/systemd/user/cn.org.linyaps.preloader.service
-   lib/sysusers.d/linglong.conf
-   lib/tmpfiles.d/linglong.conf
-   script/linglong.sh
-Index: linyaps/misc/lib/systemd/user/cn.org.linyaps.preloader.service
-===================================================================
---- /dev/null
-+++ linyaps/misc/lib/systemd/user/cn.org.linyaps.preloader.service
-@@ -0,0 +1,22 @@
-+# SPDX-FileCopyrightText: 2025 UnionTech Software Technology Co., Ltd.
-+#
-+# SPDX-License-Identifier: LGPL-3.0-or-later
-+
-+# This systemd service is used to preload Dtk and Qt libraries into the page cache,
-+# so some linyaps applications that use these libraries will start faster on their first launch
-+
-+[Unit]
-+Description=Linyaps application preloader
-+After=graphical-session.target
-+PartOf=graphical-session.target
-+BindsTo=graphical-session.target
-+
-+[Service]
-+Type=oneshot
-+ExecStartPre=/usr/bin/sleep 30s
-+ExecStart=ll-cli run cn.org.linyaps.preloader
-+Slice=app.slice
-+RemainAfterExit=yes
-+
-+[Install]
-+WantedBy=graphical-session.target
diff --git a/debian/patches/0004-deepin-skip-path-mapping.patch b/debian/patches/0004-deepin-skip-path-mapping.patch
deleted file mode 100644
index b46bcaea..00000000
--- a/debian/patches/0004-deepin-skip-path-mapping.patch
+++ /dev/null
@@ -1,25 +0,0 @@
-Index: linyaps/libs/linglong/src/linglong/cli/cli.cpp
-===================================================================
---- linyaps.orig/libs/linglong/src/linglong/cli/cli.cpp
-+++ linyaps/libs/linglong/src/linglong/cli/cli.cpp
-@@ -2207,9 +2207,17 @@ int Cli::content([[maybe_unused]] CLI::A
-         qCritical() << "failed to check symlink " << file.c_str() << ":" << ec.message().c_str();
-     }
- 
--    // Dont't mapping the file under /home
--    if (auto tmp = target.string(); tmp.rfind("/home/", 0) == 0) {
--        return target;
-+    //Do not mapping files in the following directories, which have been mounted into the container
-+    std::vector<std::string> skipMappingPaths{ "/home/",
-+                                               "/media/",
-+                                               "/usr/share/icons/",
-+                                               "/usr/share/fonts/",
-+                                               "/usr/share/wallpapers/",
-+                                               "/usr/share/themes/" };
-+    for (const auto &path : skipMappingPaths) {
-+        if (auto tmp = target.string(); tmp.rfind(path, 0) == 0) {
-+            return target;
-+        }
-     }
- 
-     return std::filesystem::path{ "/run/host/rootfs" }
diff --git a/debian/patches/0005-repo-token.patch b/debian/patches/0005-repo-token.patch
deleted file mode 100644
index 63f53a74..00000000
--- a/debian/patches/0005-repo-token.patch
+++ /dev/null
@@ -1,45 +0,0 @@
-Index: linyaps/libs/linglong/src/linglong/repo/ostree_repo.cpp
-===================================================================
---- linyaps.orig/libs/linglong/src/linglong/repo/ostree_repo.cpp
-+++ linyaps/libs/linglong/src/linglong/repo/ostree_repo.cpp
-@@ -1271,6 +1271,21 @@ utils::error::Result<void> OSTreeRepo::p
-     return LINGLONG_OK;
- }
- 
-+// 执行apt-config 获取 apt token配置
-+utils::error::Result<std::string> getAptToken() noexcept
-+{
-+    LINGLONG_TRACE("get apt token");
-+    auto aptToken = utils::command::Cmd("sh").exec({
-+      "-c",
-+      "eval `apt-config shell Token Acquire::SmartMirrors::Token`; echo $Token",
-+    });
-+
-+    if (!aptToken) {
-+        return LINGLONG_ERR(aptToken);
-+    }
-+    return aptToken->toStdString();
-+}
-+
- // 初始化一个GVariantBuilder
- GVariantBuilder OSTreeRepo::initOStreePullOptions(const std::string &ref) noexcept
- {
-@@ -1291,6 +1306,18 @@ GVariantBuilder OSTreeRepo::initOStreePu
-                           "{s@v}",
-                           "refs",
-                           g_variant_new_variant(g_variant_new_strv(refs.data(), -1)));
-+    auto token = getAptToken();
-+    if (!token) {
-+        qWarning() << "get apt token error: " << token.error().message();
-+    } else {
-+        GVariantBuilder hdr_builder;
-+        g_variant_builder_init(&hdr_builder, G_VARIANT_TYPE("a(ss)"));
-+        g_variant_builder_add(&hdr_builder, "(ss)", "X-Repo-Token", token->c_str());
-+        g_variant_builder_add(&builder,
-+                              "{s@v}",
-+                              "http-headers",
-+                              g_variant_new_variant(g_variant_builder_end(&hdr_builder)));
-+    }
-     return builder;
- }
- 
diff --git a/debian/patches/series b/debian/patches/series
deleted file mode 100644
index d5800bd0..00000000
--- a/debian/patches/series
+++ /dev/null
@@ -1,5 +0,0 @@
-0004-deepin-skip-path-mapping.patch
-0001-add-mount-dirs.patch
-0002-deepin-specifies-export-directory.patch
-0003-add-linyaps-preloader.patch
-0005-repo-token.patch
diff --git a/debian/rules b/debian/rules
index f50b918c..7568810f 100755
--- a/debian/rules
+++ b/debian/rules
@@ -4,7 +4,7 @@ include /usr/share/dpkg/pkg-info.mk
 %:
 	dh $@ --buildsystem=cmake
 
-EXTRA_OPTION = -DCPM_LOCAL_PACKAGES_ONLY=ON -DLINGLONG_VERSION=$(DEB_VERSION_UPSTREAM) -DENABLE_LINGLONG_INSTALLER=ON -DLINGLONG_EXPORT_PATH=apps/share
+EXTRA_OPTION = -DCPM_LOCAL_PACKAGES_ONLY=ON -DLINGLONG_VERSION=$(DEB_VERSION_UPSTREAM) -DENABLE_LINGLONG_INSTALLER=ON -DLINGLONG_EXPORT_PATH=apps/share -DQT_VERSION_MAJOR=5 -DQt5DBus_QDBUSXML2CPP_EXECUTABLE=/bin/qdbusxml2cpp
 
 override_dh_auto_configure:
 	dh_auto_configure --  ${EXTRA_OPTION}  ${DH_AUTO_ARGS}
diff --git a/libs/dbus-api/CMakeLists.txt b/libs/dbus-api/CMakeLists.txt
index c055fcfa..c4b9af39 100644
--- a/libs/dbus-api/CMakeLists.txt
+++ b/libs/dbus-api/CMakeLists.txt
@@ -37,7 +37,7 @@ function(linglong_add_dbus_interface target xml basename) # include
   if("${QT_VERSION_MAJOR}" STREQUAL "6")
     qt6_add_dbus_interface(INTERFACE_SOURCES ${xml} ${basename})
   else()
-    set(Qt5DBus_QDBUSXML2CPP_EXECUTABLE qdbusxml2cpp)
+    set(Qt5DBus_QDBUSXML2CPP_EXECUTABLE "${Qt5DBus_QDBUSXML2CPP_EXECUTABLE}")
     qt5_add_dbus_interface(INTERFACE_SOURCES ${xml} ${basename})
   endif()
   target_sources(${target} PRIVATE ${INTERFACE_SOURCES})
-- 
2.51.0

